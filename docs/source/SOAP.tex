\documentclass[
%journal=ancac3, % for ACS Nano
%journal=acbcct, % for ACS Chem. Biol.
%journal=jacsat, % for undefined journal
journal=jctcce, % for JCTC
manuscript=article, layout=onecolumn]{achemso}
%\usepackage[fontsize=10pt]{scrextend}
\usepackage{verbatim}
\usepackage[version=3]{mhchem} % Formula subscripts using \ce{}

\usepackage{color}
\usepackage{amsmath,bm}
\usepackage{graphicx}
\usepackage{braket}

\input{SOAP_defs.tex}


\newcommand*{\fm}[1]{{\color{green}#1}}
\newcommand*{\mv}[1]{{\color{blue}#1}}


\author{Felix Musil}
\email{felix.musil@epfl.ch}

\usepackage{bm}
\usepackage{multirow}
\usepackage[bottom]{footmisc}
\usepackage{makecell}
\usepackage{physics}
\usepackage{sectsty}



\renewcommand\theadalign{bc}
\renewcommand\theadfont{\bfseries}
\renewcommand\theadgape{\Gape[4pt]}
\renewcommand\cellgape{\Gape[4pt]}

\newcommand{\angstrom}{\text{\normalfont\AA}}

\renewcommand\thefootnote{\fnsymbol{footnote}}

\let\oldmaketitle\maketitle
\let\maketitle\relax

\title[]
{SOAP Derivation}

%a reliable and inexpensive estimate of the variance of the ML prediction also r any reason you can’t be present on this date, I kindly ask you to inform me as soon as you can.

\usepackage{hyperref}
\usepackage{cleveref}

\allsectionsfont{\normalfont\sffamily\bfseries}
\paragraphfont{\normalfont\sffamily\bfseries}

\begin{document}


\section{From the density to the density expansion}
Density expansion:
\begin{equation}
\rho^{\alpha}_i(\mathbf{r})=\sum_{j\in \alpha} \mathcal{N}_{\sigma}\left(\mathbf{r}-\mathbf{r}_{ij}\right) = 
\sum_{nlm} \braket{\alpha n \ell m}{\CX_i} B_{nlm}(\mathbf{r}), 
\end{equation}
where $\alpha$ is a tag refers to the specie of the considered atoms, $\sum_{j \in \alpha}$ defines a sum over the neighbours of atom $i$ of specie $\alpha$, $\mathcal{N}_{\sigma}$ a Gaussian centered around $0$ and variance $\sigma^2$, $B_{nlm}(\mathbf{r}) = R_n(r) Y_{\ell}^m(\hat{\mathbf{r}})$  defines a complete orthonormal basis set, $Y_{\ell}^m$ a spherical harmonic (SH),  $r=\norm{\mathbf{r}}$ and $\hat{\mathbf{r}}=\mathbf{r}/r$.

The following derivation aims at deriving expressions for the coefficients of the density expansion and their derivative with respect to atomic coordinate for several basis sets.

\subsection{Density coefficients: angular integration}
Spherical harmonics are the only orthonormal basis set of $S^2$ so this part should apply except for real space basis.


We use the orthonormality of the basis set to compute the expressiont for the density coefficients and express the resulting integral over $\rm I\!R^3$ in spherical coordinates using $\norm{\mathbf{r}-\mathbf{r}_{ij}}^2=\mathbf{r}^2+\mathbf{r}_{ij}^2-2\norm{\mathbf{r}}\norm{\mathbf{r}_{ij}}\cos{\theta}$:
\begin{equation}
\begin{split}
\braket{\alpha n \ell m}{\CX_i}=& \sum_{j \in \alpha} c^{ij}_{n \ell m} = \sum_{j \in \alpha} \int_{\rm I\!R^3} \exp\left[-a\left(\mathbf{r}-\mathbf{r}_{ij}\right)^2\right]B_{nlm}(\mathbf{r})\\
=&\sum_{j \in \alpha} \int_{0}^{\infty}r^2  \exp\left[-a\left(r^2+r_{ij}^2\right)\right] g_n(r) \int_{-1}^{1}\mathrm{d}\left(\cos{\theta}\right) \\ 
& \int_0^{2\pi}\mathrm{d}\phi \exp\left[2arr_{ij}\cos{\theta}\right]Y_{\ell}^{m}\left(\hat{\mathrm{R}}\hat{\bm{q}}\right),\\
\end{split}
\end{equation}
where $\hat{\mathrm{R}} = \hat{\mathrm{R}}_{ZYZ}\left(\alpha_{ij},\beta{ij},0\right)$ is the ZYZ-Euler matrix that rotate $\hat{e}_z$ onto $\bm{q}_{ij}$, $a=\frac{1}{2\sigma^2}$. Note that global normalization constants are omitted because of a normalization at the end.

We use the following convention for the SH
\begin{equation}
    Y_{\ell}^{m}\left(\hat{\mathbf{r}}\right)=Y_{\ell}^{m}\left(\theta,\phi\right)=A_{\ell}^{m}e^{im\phi}P^{m}_{\ell}\left(\cos\theta\right),
\end{equation}
where $A_{\ell}^{m} =\sqrt{\frac{(\ell-m)!(2l+1)}{4\pi(\ell+m)!}}$
and $\hat{q}$ is the direction vector defined by the angle $\theta$ and $\phi$. Note that the phase factor $(-1)^\ell$ is included in the definition of the Associated Legendre Polynomials (ALPs). The set of spherical harmonics is calculated in the \\ \textbf{librascal/src/math/spherical\_harmonics.cc} file, which is provided with explanations. The total number of SH in the set is $(l_{max} +1)^2$.


The integration over the angular part yields
\begin{equation}
\begin{split}
\int_{-1}^{1}\mathrm{d}\left(\cos{\theta}\right) \exp\left[arr_{ij}\cos{\theta}\right] \int_0^{2\pi}\mathrm{d}\phi Y_{\ell}^{m}\left(\hat{\mathrm{R}}\left(\alpha_{ij},\beta{ij},0\right)\hat{\bm{q}}\right) =& 4\pi Y_\ell^m \left(\beta_{ij},\alpha_{ij}\right) \mathsf{i}_{\ell}\left(arr_{ij}\right), \\
=& Y_\ell^m \left(\hat{\mathbf{r}}_{ij}\right) \mathsf{i}_{\ell}\left(arr_{ij}\right),
\end{split}
\end{equation}
where $\mathsf{i}_{\ell}$ stands for the modified spherical Bessel function of the first kind. The intermediate steps are detailed in the following paragraphs.

\paragraph{Integration over $\phi$}


The integration over the polar angle cancels out all orders of $m$ from the SH
\begin{equation}
\int_0^{2\pi}\mathrm{d}\phi Y_{\ell}^{m}\left(\theta,\phi\right) = \sqrt{\pi\left(2l+1\right)}\mathrm{P}_{\ell}^{m}\left(\cos{\theta}\right) \delta_{m0},
\end{equation}
since 


\begin{equation}
\begin{split}
\int_0^{2\pi}\mathrm{d}\phi \exp\left[im\phi\right] = 2\pi \delta_{0m}.
\end{split}
\end{equation}

Nevertheless, the rotation of the spherical harmonic breaks down into a linear combination of spherical harmonics. The coefficents are the entries of the Wigner D-matrix constructed from the Euler angles of the rotation matrix $\hat{R}$.
\begin{equation}
\begin{split}
Y_{\ell}^{m}\left(\hat{\mathrm{R}}\hat{\mathbf{r}}\right) = & \sum_{m'=-\ell}^{\ell} \mathrm{D}_{mm'}^\ell\left(\hat{R}\,\right) Y_{\ell}^{m}\left(\hat{\mathbf{r}}\right), \\
\mathrm{D}_{m0}^\ell\left(\alpha,\beta,\gamma\right) =& \sqrt{\frac{4\pi}{2l+1}} Y_l^m\left(\beta,\alpha\right). \\
\end{split}
\end{equation}


Thus, the polar integral over the rotated SH simplifies into  
\begin{equation}
\begin{split}
\int_0^{2\pi}\mathrm{d}\phi\, Y_{\ell}^{m}\left(\hat{\mathrm{R}}\hat{\mathbf{r}}\right) =& \sum_{m'=-\ell}^{\ell} \mathrm{D}_{mm'}^\ell\left(\alpha_{ij},\beta_{ij},0\right) \sqrt{\pi(2l+1)} P_{\ell}^{m'}\left(\cos{\theta}\right) \delta_{m'0} \\
=& 2\pi Y_\ell^m \left(\beta_{ij},\alpha_{ij}\right) P_{\ell}^{0}\left(\cos{\theta}\right).
\end{split}
\label{eq:int-phi}
\end{equation}

\paragraph{Integration over $\theta$}

The modified spherical Bessel function of the first kind (MSBF) admit the following integral representation

\begin{equation}
    \mathsf{i}_n\left(z\right)= \frac{1}{2}\int_{-1}^{1}\mathrm{d}x \exp\left(zx\right)\mathrm{P}_{n}^{0}\left(x\right),
\end{equation}
which can be shown using the reference relations \cref{eq:bessel-1,eq:bessel-3,eq:bessel-4} 
\begin{align}
\mathsf{j}_n\left(z\right) =& \frac{(-i)^n}{2}\int_{-1}^{1}\mathrm{d}x \exp\left[izx\right]P_{n}^{0}\left(x\right),\footnotemark[1] \label{eq:bessel-1}\\
\mathsf{i}_n\left(z\right)=& (-i)^{n} \mathsf{j}_n\left(iz\right),\footnotemark[2] \label{eq:bessel-3}\\
\mathsf{i}_n\left(z\right)=& (-1)^{n} \mathsf{i}_n\left(-z\right),\footnotemark[3] \label{eq:bessel-4}
\end{align}

\footnotetext[1]{http://dlmf.nist.gov/10.54.E2}
\footnotetext[2]{http://dlmf.nist.gov/10.47.E12}
\footnotetext[3]{http://dlmf.nist.gov/10.47.E16}

 $j_n$ is the spherical Bessel function of the first kind.
 The integral over the polar angle is then given by
\begin{equation}
\begin{split}
\int_{-1}^{1}\mathrm{d}\left(\cos{\theta}\right) \exp\left[2arr_{ij}\cos{\theta}\right]P_{\ell}^{0}\left(\cos{\theta}\right) =& 2 \mathsf{i}_{\ell}(2arr_{ij}). 
\end{split}
\end{equation}



\subsection{Density coefficients: Radial integration}
Summing up the results from the previous section:
\begin{equation}
c^{ij}_{n\ell m} = 4\pi Y_{\ell}^m(\hat{\mathbf{r}}_{ij}) \exp\left[-ar^2_{ij}\right] \underbrace{\int_0^\infty \dd{r} r^2 R_n(r) e^{-ar^2} \mathsf{i}_{\ell}\left(2a r r_{ij}\right)}_{=\text{I}_{n\ell}^{ij}} ,
\end{equation}
we identify $\text{I}_{n\ell}^{ij}$ as the last term to simplify for particular choices of radial basis functions.

\subsubsection{GTO like radial basis}
The Gaussian Type Orbital radial basis is defined
\begin{equation}
   R^{GTO}_{n}(r) = \mathcal{N}_n\ r^{n} \exp[-br^2],
\end{equation}
where $b=\frac{1}{2\sigma_n^2}$, $\sigma_n = (r_\text{cut}-\delta r_\text{cut}) \max(\sqrt{n},1)/n_\text{max}$ and the normalization factor is given by
\begin{equation}
\mathcal{N}_n^2 = \frac{2(1)}{\sigma_n^{2n + 3}\Gamma(n + 3/2)}.
\end{equation}
The overlap between GTO radial basis is:
$$\int_0^\infty R^{GTO}_{n}(r) R^{GTO}_{n^\prime}(r) \dd{r}= 2 \left(\frac{1}{2 \sigma_{n}^2}+\frac{1}{2 \sigma_{n^\prime}^2} \right)^{-\frac{1}{2} (3+n+n^\prime)} \Gamma(\frac{3+n+n^\prime}{2}) $$
This equals what we use in the implementation
$$\int_0^\infty R^{GTO}_{n}(r) R^{GTO}_{n^\prime}(r) \dd{r}= N_n N_{n^\prime} \left(\frac{1}{2 \sigma_{n}^2}+\frac{1}{2 \sigma_{n^\prime}^2} \right)^{-\frac{1}{2} (3+n+n^\prime)} \Gamma(\frac{3+n+n^\prime}{2}) $$


The radial integral becomes
\begin{equation}
    I^{ij\,\text{GTO}}_{nl}= \mathcal{N}_n \frac{\sqrt{\pi}}{4} \frac{\Gamma\left(#1\right){\frac{n+\ell+k+3}{2}}}{\Gamma\left(#1\right){\ell+\frac{3}{2}}}a^\ell r_{ij}^\ell(a+b)^{-\frac{n+k+\ell+3}{2}}  {}_{1}F_{1}\left(#1 ,#2, #3 \right){\frac{n+\ell+k+3}{2}}{\ell+\frac{3}{2}}{\frac{a^2 r_{ij}^2}{a+b}},
    \label{eq:rad-int-gto-1}
\end{equation}
which yields the following expression for the neighbour contribution

\begin{align}
    c^{ij\,\text{GTO}}_{n\ell m}=& (\pi)^{\frac{3}{2}} \mathcal{N}_n \frac{\Gamma\left(#1\right){\frac{n+\ell+3}{2}}}{\Gamma\left(#1\right){\ell+\frac{3}{2}}} (a+b)^{-\frac{n+\ell+3}{2}}  \\
    & Y_{\ell}^m(\hat{\mathbf{r}}_{ij}) \exp\left[-ar^2_{ij}\right]   (a\rij)^\ell  {}_{1}F_{1}\left(#1 ,#2, #3 \right){\frac{n+\ell+3}{2}}{\ell+\frac{3}{2}}{\frac{a^2 \rij^2}{a+b}}.
    \label{eq:density-gto}
\end{align}

where $\Gamma$ is the Gamma function, and ${}_1F_1$ is the confluent hypergeometric function of the first kind. 

The neighbour contribution is calculated in \\ file \textbf{librascal/src/representations/ representation\_manager\_spherical\_expansion.hh}, \\ function \textbf{compute\_neighbour\_contribution}, line 338.

The steps of the derivation are detailed in the next paragraph.
\paragraph{Analytic radial integral}

We write an integral representation of the confluent hypergeometric function ${}_{1}F_{1}\left(#1 ,#2, #3 \right){a}{b}{z}$ (CHF) in terms of MSBF:
\begin{equation}
{}_{1}F_{1}\left(#1 ,#2, #3 \right){a}{\ell+\frac{3}{2}}{x} = \frac{2x^{-\frac{\ell}{2}}}{\sqrt{\pi}}\frac{\Gamma\left(#1\right){\ell+\frac{3}{2}}}{\Gamma\left(#1\right){a}}\int_0^\infty e^{-t} t^{a-1-\frac{\ell}{2}} \mathsf{i}_{\ell}(2\sqrt{xt})\dd{t},
\label{eq:chf-int}
\end{equation}
using these relations

\begin{align}
{}_{1}F_{1}\left(#1 ,#2, #3 \right){a}{b}{z} = & \frac{1}{\Gamma\left(#1\right){a}} \int_0^\infty e^{-t}t^{a-1}{}_{0}F_{1}\left(#1,#2\right){b}{zt}\dd{t},\footnotemark[9]\\
I_l(z) =& \frac{(\frac{z}{2})^{\ell}}{\Gamma\left(#1\right){l+1}} {}_{0}F_{1}\left(#1,#2\right){\ell+1}{\frac{z^2}{4}},\footnotemark[10]\\
\mathsf{i}_{\ell}(z) =& \sqrt{\frac{\pi}{2z}}I_{\ell+1/2}(z),\footnotemark[11]\\
\mathsf{i}_{\ell}(z) =& \sqrt{\frac{\pi}{4}}\frac{(\frac{z}{2})^{\ell}}{\Gamma\left(#1\right){\ell+\frac{3}{2}}} {}_{0}F_{1}\left(#1,#2\right){\ell+\frac{3}{2}}{\frac{z^2}{4}},\\
{}_{0}F_{1}\left(#1,#2\right){\ell+\frac{3}{2}}{xt}=& \sqrt{\frac{4}{\pi}}\Gamma\left(#1\right){\ell+\frac{3}{2}} x^{-\frac{\ell}{2}}t^{-\frac{\ell}{2}}\mathsf{i}_{\ell}(2\sqrt{xt}),
\end{align}
\footnotetext[9]{\url{http://functions.wolfram.com/HypergeometricFunctions/Hypergeometric1F1/07/01/01/0002/} or \url{http://dlmf.nist.gov/16.5.E3}}
\footnotetext[10]{\url{https://en.wikipedia.org/wiki/Generalized_hypergeometric_function##The_series_0F1}}
\footnotetext[11]{\url{http://mathworld.wolfram.com/ModifiedSphericalBesselFunctionoftheFirstKind.html}}

where $I_\ell$ is the modified Bessel function and ${}_{0}F_{1}\left(#1,#2\right){b}{z}$ is the limit conflent hypergeometric function.

The module for calculating ${}_{1}F_{1}\left(#1 ,#2, #3 \right){..}{..}{..}$ is located in \textbf{librascal/src/math/hyp1f1.hh}.

The radial integral with GTO radial basis function is:
\begin{equation}
    I^{ij\,\text{GTO}}_{nl}=\int_0^\infty \dd{r} r^{2+k} g^{\text{GTO}}_n(r) e^{-\frac{r^2}{2\sigma^2}} \mathsf{i}_{\ell}\left(r r_{ij} / \sigma^2\right) = \mathcal{N}_n \int_0^\infty \mathrm{d}r r^{2+k+n}  e^{-r^2(a+b)} \mathsf{i}_{\ell}\left(2a r r_{ij}\right),
    \label{eq:rad-int-gto-0}
\end{equation}
with $k$ an additional power of $r$ that will be non zero for the derivative. We partially identify the terms between \cref{eq:chf-int} and \cref{eq:rad-int-gto-0}:
\begin{align}
    t =& r^2(a+b),\\
    \dd{t} =& 2 r \dd{r} (a+b),\\
    x = & \frac{a^2 \rij^2}{a+b},
\end{align}
to change the integrand of the radial integral
\begin{equation}
    I^{ij\,\text{GTO}}_{nl}= \mathcal{N}_n \int_0^\infty \frac{\dd{t}}{2(a+b)} (a+b)^{-\frac{n+k+1}{2}} t^{\frac{n+k+1}{2}}  e^{-t} \mathsf{i}_{\ell}\left(2\sqrt{xt}\right),
    \label{eq:rad-int-gto-01}
\end{equation}
and identify the last term
\begin{align}
    a =& \frac{n+\ell+k+3}{2}.
\end{align}

\subsubsection{Numerical Integration of the Radial Integral}

The numerical integration does not rely on a specific form of the radial basis
\begin{equation}
    \text{I}_{n\ell}^{ij} = \sum_{k=1}^{K} \omega_k  r_k^2 R_n(r_k) e^{-ar_k^2} \mathsf{i}_{\ell}\left(2a r_k r_{ij}\right),
\end{equation}
where the $\omega_k$ are the quadrature weights evaluated at the quadrature nodes $r_k$. Depending on the quadrature rule, the following shifting formula is useful,
$$\int_a^b f(x)\,\dd{x} \approx \frac{b-a}{2} \sum_{i=1}^n w_i f\left(\frac{b-a}{2}x_i + \frac{a+b}{2}\right).$$

\paragraph{Discrete Variable Representation}

In the special case of the the DVR radial basis\footnotemark[1] with Gauss-Legendre quadrature rule, the radial integral simplifies into:
\begin{equation}
    \text{I}_{n\ell}^{ij} = \frac{r_c}{2} \sqrt{\omega_n} x_n^2 e^{-ax_n^2} \mathsf{i}_{\ell}\left(2a x_n r_{ij}\right),
\end{equation}
where $x_n=\frac{r_c}{2}r_n+\frac{r_c}{2}$.

\footnotetext[1]{Light, J. C., & Carrington, T. (2007). Discrete-Variable Representations and their Utilization (pp. 263–310). John Wiley & Sons, Ltd. \url{https://doi.org/10.1002/9780470141731.ch4}}

\subsection{Gradient of the density coefficients with respect to the Cartesian coordinates}
The density coefficients can be split into 2 parts: one that depends on the choice of radial basis function ($\text{I}_{n\ell}^{ij}$) and the rest:
\begin{equation}
c^{ij}_{n\ell m} =  Y_{\ell}^m(\hat{\mathbf{r}}_{ij}) \exp\left[-ar^2_{ij}\right] \text{I}_{n\ell}^{ij} =  D^{ij}_{\ell m} C^{ij} \text{I}_{n\ell}^{ij},
\end{equation}

where $C^{ij}$ is the Gaussian exponential factor and $\bar{D}^{ij}_{\ell m} = \bar{Y}_{\ell,m}(\hat{r}_{ij})$ is the spherical harmonic, see eq. \eqref{eq:real-spherical-harmonics}. Note the constant factors are omitted.


The following derivations end up with this formula that does not depend on the radial basis:
\begin{align}
    \grad_i\,c^{ij}_{\alpha n \ell m} =& 2a c^{ij}_{\alpha n \ell m} \mathbf{r}_{ij}\nonumber\\
    &{} +  C \bar{D}^{ij}_{\ell m} \cdot \grad_i \text{I}_{n\ell}^{ij}\nonumber\\
    &{} + N_{n \ell}A_{n\ell} B_\ell C \cdot \grad_i\,\bar{D}^{ij}_{\ell,m},
\end{align}
where $\grad_i\bar{D}^{ij}_{\ell,m} = \grad_i \bar{Y}_{\ell,m}(\hat{r}_{ij})$ is defined in \cref{eq:dbx0,eq:dbx1,eq:dbx2,eq:dby0,eq:y1,eq:dby2,eq:dbz0,eq:dbz1,eq:dbz2}.

\subsubsection{Terms common to the different radial basis}
\paragraph{Gaussian}

\begin{gather}
    \dv{C^{ij}}{r_{ij}} = -2ar_{ij}C^{ij}
\end{gather}

\paragraph{Length}

So for the radial terms, we just use the derivatives of the radius $r_{ij}$ wrt the Cartesian coordinates:
\begin{gather}
    \dv{ r_{ij}}{ \{x_i, y_i, z_i\}} = -\frac{\{x_{ij}, y_{ij}, z_{ij}\}}{r_{ij}}\\
    \grad_i\,r_{ij} = \frac{-\bvec{r}_{ij}}{r_{ij}}\\
    \text{where }\bvec{r}_{ij} = \bvec{r}_j - \bvec{r}_i
\end{gather}

\paragraph{Spherical Harmonics}
The derivative of the spherical harmonic can be expressed in a few different ways.  The versions below are in terms of the original harmonic with possibly different $m$ values.  The $z$ component is:
\begin{align}
    \frac{\partial D_{\ell m}}{\partial z_i} &= \frac{-\sqrt{1-u^2}}{2r}\left(e^{i\phi}\sqrt{(\ell+m)(\ell-m+1)}Y_l^{m-1}(\hat{r})
        - e^{-i\phi}\sqrt{(\ell-m)(\ell+m+1)}Y_l^{m+1}(\hat{r})\right)\nonumber\\
    &= \frac{-\sin{\theta}}{2r_{ij}}(\cos(m\phi) + i\sin(m\phi))
    \left(\sqrt{(\ell+m)(\ell - m + 1)}\sqrt{\frac{2\ell+1}{4\pi}\frac{(\ell-m+1)!}{(\ell+m-1)!}}
        P_l^{m-1}(\cos{\theta})\right.\nonumber\\
    &\qquad\qquad \left. {} - \sqrt{(\ell-m)(\ell + m + 1)}\sqrt{\frac{2\ell+1}{4\pi}\frac{(\ell-m-1)!}{(\ell+m+1)!}}
    P_l^{m+1}(\cos{\theta})\right)
\end{align}
But remember, we're actually using the real spherical harmonics:
\begin{subequations}
\label{eq:real-spherical-harmonics}
\begin{align}
    \left.\begin{aligned}
    \bar{Y}_{\ell m}(\hat{r}_{ij}) &= \cos(m\phi) \bar{P}_\ell^m(\cos{\theta})\\
    \bar{Y}_{\ell,-m}(\hat{r}_{ij}) &= \sin(m\phi) \bar{P}_\ell^m(\cos{\theta})
    \end{aligned}\right\}&\text{ for }m > 0\\
    \bar{Y}_{\ell,0}(\hat{r}_{ij}) = \frac{1}{\sqrt{2}} \bar{P}_\ell^0(\cos{\theta})&
\end{align}
where
\begin{equation}
    \bar{P}_\ell^m(\cos{\theta}) = \sqrt{\frac{2\ell + 1}{2\pi}\frac{(\ell - m)!}{(\ell + m)!}}P_\ell^m(\cos{\theta}).
\end{equation}
\end{subequations}

So we can write
\begin{align}
    \frac{\partial \bar{D}_{\ell m}}{\partial z_i} &=
    \frac{-\sin\theta}{2r_{ij}}\cos(m\phi)\left(\sqrt{(\ell + m)(\ell - m + 1)}\bar{P}_\ell^{m-1}(\cos\theta)
        - \sqrt{(\ell - m)(\ell + m + 1)}\bar{P}_\ell^{m+1}(\cos\theta)\right) \label{eq:dbz0}\\
    \frac{\partial \bar{D}_{\ell,-m}}{\partial z_i} &=
    \frac{-\sin\theta}{2r_{ij}}\sin(m\phi)\left(\sqrt{(\ell + m)(\ell - m + 1)}\bar{P}_\ell^{m-1}(\cos\theta)
        - \sqrt{(\ell - m)(\ell + m + 1)}\bar{P}_\ell^{m+1}(\cos\theta)\right)\label{eq:dbz1}\\
    \frac{\partial \bar{D}_{\ell,0}}{\partial z_i} &= 
        \frac{\sin\theta}{r_{ij}}
            \sqrt{\frac{\ell(\ell + 1)}{2}}\bar{P}_\ell^{1}(\cos\theta))\label{eq:dbz2}
\end{align}
(the last one comes from the identity $\sqrt{\frac{(\ell+m)!}{(\ell-m)!}}P_\ell^{-m} = (-1)^m \sqrt{\frac{(\ell - m)!}{(\ell + m)!}}P_l^m(\cos\theta)$ with $m=1$).

The $x$ component is:
\begin{align}
    \frac{\partial \bar{D}_{\ell m}}{\partial x_i} &= \frac{-m\sin\phi}{\sqrt{x_{ij}^2 + y_{ij}^2}} \bar{D}_{\ell,-m} + \frac{\cos\phi \cos\theta}{2r_{ij}}\cos(m\phi)\left(
        \sqrt{(\ell + m)(\ell - m + 1)}\bar{P}_\ell^{m-1}(\cos\theta)\right.\nonumber\\
        &\qquad\qquad\qquad\left. {} - \sqrt{(\ell - m)(\ell + m + 1)}\bar{P}_\ell^{m+1}(\cos\theta)\right)\label{eq:dbx0}\\
    \frac{\partial \bar{D}_{\ell,-m}}{\partial x_i} &= \frac{m\sin\phi}{\sqrt{x_{ij}^2 + y_{ij}^2}} \bar{D}_{\ell,m} + \frac{\cos\phi \cos\theta}{2r_{ij}}\sin(m\phi)\left(
        \sqrt{(\ell + m)(\ell - m + 1)}\bar{P}_\ell^{m-1}(\cos\theta)\right.\nonumber\\
        &\qquad\qquad\qquad\left. {} - \sqrt{(\ell - m)(\ell + m + 1)}\bar{P}_\ell^{m+1}(\cos\theta)\right)\label{eq:dbx1}\\
    \frac{\partial \bar{D}_{\ell,0}}{\partial x_i} &=
        \frac{-\cos\phi \cos\theta}{r_{ij}}\sqrt{\frac{\ell(\ell+1)}{2}}\bar{P}_\ell^1(\cos\theta)\label{eq:dbx2}
\end{align}
and for the $y$ component, similarly:
\begin{align}
    \frac{\partial \bar{D}_{\ell m}}{\partial y_i} &= \frac{m\cos\phi}{\sqrt{x_{ij}^2 + y_{ij}^2}} \bar{D}_{\ell,-m} + \frac{\sin\phi \cos\theta}{2r_{ij}}\cos(m\phi)\left(
        \sqrt{(\ell + m)(\ell - m + 1)}\bar{P}_\ell^{m-1}(\cos\theta)\right.\nonumber\\
        &\qquad\qquad\qquad\left. {} - \sqrt{(\ell - m)(\ell + m + 1)}\bar{P}_\ell^{m+1}(\cos\theta)\right)\label{eq:dby0}\\
    \frac{\partial \bar{D}_{\ell,-m}}{\partial y_i} &= \frac{-m\cos\phi}{\sqrt{x_{ij}^2 + y_{ij}^2}} \bar{D}_{\ell,m} + \frac{\sin\phi \cos\theta}{2r_{ij}}\sin(m\phi)\left(
        \sqrt{(\ell + m)(\ell - m + 1)}\bar{P}_\ell^{m-1}(\cos\theta)\right.\nonumber\\
        &\qquad\qquad\qquad\left. {} - \sqrt{(\ell - m)(\ell + m + 1)}\bar{P}_\ell^{m+1}(\cos\theta)\right)\label{eq:dby1}\\
    \frac{\partial \bar{D}_{\ell,0}}{\partial y_i} &=
        \frac{-\sin\phi \cos\theta}{r_{ij}}\sqrt{\frac{\ell(\ell+1)}{2}}\bar{P}_\ell^1(\cos\theta)\label{eq:dby2}
\end{align}

The formul\ae\ above have a singularity at the poles for $m \neq 0$, so use the following identity:
\begin{multline}
    \frac{m}{\sqrt{x_{ij}^2 + y_{ij}^2}} \begin{pmatrix}\bar{Y}_{\ell, -m}(\hat{r}_{ij})\\
                                                         \bar{Y}_{\ell,  m}(\hat{r}_{ij})\end{pmatrix}
        = \frac{-1}{2z_{ij}}\begin{pmatrix}\sin(m\phi)\\\cos(m\phi)\end{pmatrix}
            \left(\sqrt{(\ell+m)(\ell - m + 1)}\bar{P}_\ell^{m-1}(\cos\theta) \right.\\
            \left. {} + \sqrt{(\ell - m)(\ell + m + 1)}\bar{P}_\ell^{m+1}(\cos\theta)\right)
\end{multline}
to shift the singularity to the equator ($z=0$).
In the code derivatives of spherical harmonics is computed in the \textbf{feat/soap\_gradients branch}, \textbf{librascal/src/math/spherical\_harmonics.hh}

\subsubsection{GTO like radial basis}

We rewrite \cref{eq:rad-int-gto-1} 

\begin{equation}
    I^{ij\,\text{GTO}}_{nl} = N_{n\ell} \cdot A_{n\ell} \cdot B_\ell ,
\end{equation}
where $B_{\ell} = r_{ij}^{\ell}$,
$A_{n\ell} = {}_{1}F_{1}\left(#1 ,#2, #3 \right){\frac{n + \ell + 3}{2}}{\ell+\frac{3}{2}}{\frac{a^2 r_{ij}^2}{a+b}}$, $N_{n \ell} = \frac{\mathcal{N}_n}{4} a^\ell\left(a+b\right)^{-\frac{n + \ell + 3}{2}}  \frac{\Gamma\left(\frac{n + \ell + 3}{2}\right)}{\Gamma\left(\frac{3}{2} + \ell\right)}$,
$\mathcal{N}_n = \sqrt{\frac{2}{\sigma_n^{2n+3}\Gamma\left(n + \frac{3}{2}\right)}}$. Note that some constant multiplying factors of $\pi$ have been omitted.

\paragraph{$B_{\ell}$}

\begin{equation}
    \dv{B_\ell}{r_{ij}} = \frac{\ell}{r_{ij}} B_\ell
\end{equation}

\paragraph{CHF}
for the hypergeometric term:
\begin{equation}
    \dv{A_{n \ell}}{r_{ij}} = \frac{\frac{n + \ell + 3}{2}}{\left(\ell + \frac{3}{2}\right)}
    \frac{2a^2 r_{ij}}{a+b}
    {}_{1}F_{1}\left(#1 ,#2, #3 \right){\frac{n + \ell + 5}{2}}{\ell+\frac{5}{2}}{\frac{a^2 r_{ij}^2}{a+b}}
\end{equation}
which is not proportional to $A_{n \ell}$, or even to $A_{n+1,\ell + 1}$ -- so just recompute it explicitly.

\paragraph{GTO formula for practical computation}

Finally, putting the radial and angular components together, we get:
\begin{align}
    \grad_i\,c^{ij}_{\alpha n \ell m} &= c^{ij}_{\alpha n \ell m}\left(-\frac{\ell}{r_{ij}^2} + 2a\right)\mathbf{r}_{ij}\nonumber\\
    &{} + N_{n \ell}B_\ell C \bar{D}_{\ell m} \cdot \frac{\frac{n + \ell + 3}{2}}{\left(\ell + \frac{3}{2}\right)}
    \frac{2a^2}{a+b}
    {}_{1}F_{1}\left(#1 ,#2, #3 \right){\frac{n + \ell + 5}{2}}{\ell+\frac{5}{2}}{\frac{a^2 r_{ij}^2}{a+b}} \bvec{r}_{ij}\nonumber\\
    &{} + N_{n \ell}A_{n\ell} B_\ell C \cdot \nabla_i\,\bar{D}_{\ell,m}
\end{align}
where the gradient of the spherical harmonic has already been computed separately using the equations above.

Gradient of the coefficients is calculated in \textbf{feat/soap\_gradients} branch, \\ file \textbf{librascal/src/representations/representation\_manager\_spherical\_expansion.hh}, \\ function \textbf{compute\_neighbour\_derivative}, line 420.

\subsubsection{Numerical Integration}

Using the recurrence relation of the MSBF\footnotemark[2]:
\begin{equation}
    \dv{\mathsf{i}_{\ell}(x)}{x} = \frac{1}{2\ell+1}[\ell\mathsf{i}_{\ell-1}(x)+(\ell+1)\mathsf{i}_{\ell+1}(x)],
\end{equation}
the gradient of the radial integral becomes:
\begin{equation}
    \grad_i \text{I}_{n\ell}^{ij} = -\frac{2a}{2\ell+1}\sum_{k=1}^{K} \omega_k  r_k^3 R_n(r_k) e^{-ar_k^2} [\ell\mathsf{i}_{\ell-1}(2a r_k r_{ij})+(\ell+1)\mathsf{i}_{\ell+1}(2a r_k r_{ij})] \hat{\mathbf{r}}_{ij}.
\end{equation}

In the case of the DVR radial basis:

\begin{equation}
    \text{I}_{n\ell}^{ij} = -\frac{2a\sqrt{\omega_n}}{2\ell+1}\frac{r_c}{2}  x_n^3 e^{-ax_n^2} [\ell\mathsf{i}_{\ell-1}(2a x_n r_{ij})+(\ell+1)\mathsf{i}_{\ell+1}(2a x_n r_{ij})] \hat{\mathbf{r}}_{ij},
\end{equation}
where $x_n=\frac{r_c}{2}r_n+\frac{r_c}{2}$.



\footnotetext[2]{\url{http://mathworld.wolfram.com/ModifiedSphericalBesselFunctionoftheFirstKind.html}}


\end{document}
